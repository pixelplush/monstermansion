function e(e,t,a,o){return Math.abs(a-e)+Math.abs(o-t)}let t=[1,9,0,0,1,0,1,0,9,0,0,1,0,0,0,0,1,9,1,0,1,1,1,0,1,9,0,0,1,0,0,1,9,1,0,0,0,1,1,9,0,1,1,9,1,1,0,0,0,1,1,0,9,0,9,0,1,1,1,0,1,0,1,1,1,9,0,1,0,1,1,0,1,9,1,0,9,0,9,1,1,9,1,1,1,0,9,9,1,9,1,9,1,9,0,0,1,9,0,1,9,1,0,1,1,1,0,1,1,1,1,1,1,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,9,1,9,1,1,1,1,9,0,9,0,1,0,9,0,0,1,0,1,1,1,1,0,0,1,0,0,1,1,0,0,0,1,1,1,1,9,9,1,1,1,9,1,0,9,9,1,0,9,1,9,0,0,0,9,0,0,9,1,1,1,1,1,9,0,1,9,0,9,0,0,1,1,1,0,1,0,1,0,0,9,1,1,0,0,1,0,0,9,0,1,0,9,1,0,0,1,0,1,0,9,0,1],a=[1,0,1,9,0,1,9,9,1,1,9,9,0,1,9,1,1,0,0,1,0,1,1,0,9,0,9,1,1,9,0,1,1,0,1,1,1,9,0,0,1,1,9,1,1,0,1,9,1,1,9,0,0,9,1,9,1,1,0,0,1,9,0,0,9,1,1,0,1,0,1,1,0,9,1,0,0,1,9,1,1,1,0,0,1,0,0,1,1,9,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,1,1,0,1,9,0,0,9,0,0,9,0,1,0,0,9,1,1,1,9,9,1,1,1,0,9,0,1,0,0,1,9,1,1,1,1,9,0,0,0,1,0,1,0,1,1,1,0,1,1,0,0,1,1,0,9,1,1,1,9,1,0,1,1,0,9,1,1,0,0,0,0,0,1,0,1,1,0,9,9,1,1,1,9,1,1,9,9,1,1,9,1,9,0,9,1,1,9,1,1,0,0,1,9,9,1,9,1,1,9,1],o=[];for(let e=0;e<11;e++)for(let a=0;a<21;a++)o.push(t[21*e+a]),a<20&&o.push(0);let n=[];for(let e=0;e<10;e++)for(let t=0;t<22;t++)n.push(a[22*e+t]),t>0&&t<20&&n.push(1);let r=[];for(let e=0;e<41;e++)r.push(1);for(let e=0;e<21;e++)for(let t=0;t<41;t++)e%2==0?r.push(o[41*Math.floor(e/2)+t]):r.push(n[41*Math.floor(e/2)+t]);for(let e=0;e<41;e++)r.push(1);function s(e){return 1+2*e}function i(e){return 96*Math.floor(e/2)+48}function l(e){return 2*Math.floor(e/96)+1}function c(e){return Math.floor((e-1)/2)}const p={};function f(e){return!!p[e.toUpperCase()]}["A","B","C","D","E","F","G","H","I","J","K"].forEach((e,t)=>{for(let a=0;a<20;a++)p[e+(a+1)]={x:a,y:t}}),window.WebFontConfig={custom:{families:["Pixeltype"]},active(){Unicorn.Create("unicorn-display",{width:1920,height:1056,background:"transparent",init:se,update:ce,channel:y.channel,username:y.oauth?y.channel:void 0,password:y.oauth,onCommand:ge,onChat:xe,gravity:{x:0,y:0}}),ComfyJS.onConnected=(e,t,a)=>{a&&(setInterval(()=>{be()},6e4),be())}}},function(){const e=document.createElement("script");e.src=`${"https:"===document.location.protocol?"https":"http"}://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js`,e.type="text/javascript",e.async="true";const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();let h="Monster Mansion",d={},y={},m="",u="*BOO*",g="steal",x=!0,b=3,M=5,O=1,U=PIXI.RenderTexture.create(1920,1080),$=new PIXI.Container,C={};let I=0,k=!1;let v,A,w,E,P,L,S,_,j,z=[],N=[],B="",T=[],D=[],R=[],F=["front","back","left","right"],X=-1,J=-1,H=null,W={},G={},V=0,Y=[],K=null,Z=0,q=-1,Q=-1;let ee=3e3;r=r.map(e=>9===e?0:e);let te=[];let ae=!1;function oe(e){ae=!0,re(e)}function ne(e){ae=!1}function re(e){if(ae){let t=e.data.originalEvent.layerX,a=e.data.originalEvent.layerY,o=c(l(t)),n=c(l(a)),r=Object.keys(p).filter(e=>p[e].x===o&&p[e].y===n)[0];ComfyNetwork.isServer?ue(ComfyNetwork.id,r,"#ffffff"):ComfyNetwork.send(r)}}function se(){PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,Unicorn.Load("map",`${m}/assets/${d.map}.png`);let e=Unicorn.AddBacklay("map","map",0,-9,{scale:{x:3,y:3}});if(e.interactive=!0,e.buttonMode=!0,e.on("pointerdown",oe),e.on("pointerup",ne),e.on("pointermove",re),console.log(e),d.lightCharacters){const e=new PIXI.Graphics;e.beginFill(0,.925),e.drawRect(0,0,1920,1080),e.endFill(),$.addChild(e),$.blendMode=PIXI.BLEND_MODES.ADD}Unicorn.Load("light_glow",`${m}/assets/effects/light_glow.png`),Unicorn.Load("glow",`${m}/assets/effects/lantern_glow.png`),Unicorn.Load("tombstone",`${m}/assets/items/${d.deathItem}.png`),d.glows.forEach((e,t)=>{let a=Unicorn.AddOverlay("lantern"+t,"glow",3*e.x,3*e.y);a.anchor.set(.5),a.scale.x=5.5,a.scale.y=5.5;let o=null;d.lightCharacters&&(o=new PIXI.Sprite(assetReference.light_glow),o.position.x=3*e.x,o.position.y=3*e.y,o.scale={x:7,y:7},o.anchor.set(.5),$.addChild(o)),setInterval(()=>{a.alpha=Math.random()<.1?0:1,o&&(o.alpha=a.alpha),setTimeout(()=>{a.alpha=1,o&&(o.alpha=a.alpha)},200+200*Math.random())},500+500*Math.random())}),Unicorn.Load("walls",`${m}/assets/${d.walls}.png`);let t=Unicorn.AddOverlay("walls","walls",0,0);if(t.scale.x=3,t.scale.y=3,d.lanterns){Unicorn.Load("lanterns",`${m}/assets/${d.lanterns}.png`);let e=Unicorn.AddOverlay("lanterns","lanterns",0,0);e.scale.x=3,e.scale.y=3}d.fog.forEach((e,t)=>{Unicorn.Load(`fog${t}`,`${m}/assets/${e}.png`)});for(let e=0;e<11;e++)for(let t=0;t<20;t++){let a=i(s(t)),o=i(s(e)),n="fog"+Math.floor(Math.random()*d.fog.length),r=Unicorn.AddOverlay("fog"+t+"_"+e,n,a,o,{z:1});r.scale.x=3,r.scale.y=3,r.anchor.set(.5),8<t&&t<12&&3<e&&e<6&&(r.alpha=0),Math.random()>.15&&(r.alpha=0),R.push(r)}setInterval(pe,1e3),d.numbers?Unicorn.Load("guide",`${m}/assets/${d.numbers}.png`):Unicorn.Load("guide",`${m}/assets/numbers_g.png`);let a=Unicorn.AddOverlay("guide","guide",0,0);a.scale.x=3,a.scale.y=3,Object.keys(d.prizes).forEach(e=>{d.animatedPrizes&&d.animatedPrizes[e]&&Object.keys(d.animatedPrizes[e]).forEach(t=>{for(let a=0;a<d.animatedPrizes[e][t];a++)Unicorn.Load(`${e}_${t}${a}`,`${m}/assets/items/${e}_${t}/${e}_${t}${a+1}.png`)}),Unicorn.Load(e,`${m}/assets/items/${e}.png`)}),Object.keys(d.traps).forEach(e=>{Unicorn.Load(e,`${m}/assets/items/${e}.png`)});for(let e in d.characters)if("ghost"===e){let t=d.characters[e];for(let a=1;a<19;a++)Unicorn.Load(t+(a-1),`${m}/assets/characters/${e}/${t}${a}.png`)}else F.forEach(t=>{let a=d.characters[e]+"_"+t;for(let t=1;t<11;t++)Unicorn.Load(a+(t-1),`${m}/assets/characters/${e}/${a}/${a}${t}.png`)});if(Unicorn.Load("star_blue",`${m}/assets/icons/star_blue.png`),v=Unicorn.AddOverlay("tagStar","star_blue",-1e3,-1e3),v.scale.x=3,v.scale.y=3,v.anchor.set(.5),Unicorn.Load("star",`${m}/assets/icons/star.png`),_=Unicorn.AddOverlay("star","star",-1e3,-1e3),_.scale.x=3,_.scale.y=3,_.anchor.set(.5),Unicorn.Load("start",`${m}/assets/${d.instructions}.png`),A=Unicorn.AddOverlay("gameStart","start",50,50,{z:100}),A.scale.x=3,A.scale.y=3,y.showBannerAd&&Unicorn.Load("banner_ad",`${m}/assets/banner.png`),w=Unicorn.AddOverlay("banner_ad","banner_ad",1360,50,{z:101}),w.scale.x=3,w.scale.y=3,d.sleigh&&(Unicorn.Load("sleigh",`${m}/assets/${d.sleigh}.png`),j=Unicorn.AddOverlay("santaSleigh","sleigh",0,-1e3,{z:10}),j.scale.x=3,j.scale.y=3),Unicorn.Load("end_bg",`${m}/assets/${d.endBG}.png`),E=Unicorn.AddOverlay("end_bg","end_bg",0,0,{z:100}),E.scale.x=3,E.scale.y=3,E.alpha=0,d.scoreBoard.forEach((e,t)=>{Unicorn.Load(`scoreboard${t}`,`${m}/assets/${e}.png`);let a=Unicorn.AddOverlay("scoreboard","scoreboard"+t,1280,d.scoreBoardVerticalOffset,{z:100});a.scale.x=3,a.scale.y=3,a.alpha=0,Y.push(a)}),Unicorn.Load("end_sign",`${m}/assets/${d.banner}.png`),L=Unicorn.AddOverlay("end_sign","end_sign",250+(d.bannerHorizontalOffset?d.bannerHorizontalOffset:0),50,{z:110}),L.scale.x=3,L.scale.y=3,L.alpha=0,Unicorn.Load("end_note",`${m}/assets/${d.endNote}.png`),P=Unicorn.AddOverlay("end_note","end_note",200,400+(d.endVerticalOffset?d.endVerticalOffset:0),{z:100}),P.scale.x=3,P.scale.y=3,P.alpha=0,S=Unicorn.AddText("scores","Scores:",1400,250,{fontFamily:"Pixeltype",fontSize:50,fontWeight:"bold",fill:d.scoreboardColor||"#ffffff",z:100}),S.alpha=0,ComfyNetwork.isServer){for(let e=0;e<b;e++)he();for(let e=0;e<M;e++)fe();if(y.addBoss)for(let e=0;e<O;e++)setTimeout(de,1e3*e)}if(d.snow&&Unicorn.AddParticles("snowupdown",{blendMode:PIXI.BLEND_MODES.DEFAULT,shape:"line",angle:Math.PI/2,startColor:"#ffffff",endColor:"#ffffff",intensity:2,minSpeed:.05,maxSpeed:.2,decay:15},0,-200),d.lightCharacters){app.stage.addChild(a);let e=PIXI.Sprite.from(U);e.blendMode=PIXI.BLEND_MODES.MULTIPLY,groupOverlay.addChild(e);let t=new PIXI.SpriteMaskFilter(PIXI.Sprite.from(U));t.blendMode=PIXI.BLEND_MODES.OVERLAY,groupWorld.filters=[t]}}function ie(){x=!0;let e=le();q=e.x,Q=e.y,Z=3e3}function le(){let e=Math.floor(20*Math.random()),t=Math.floor(11*Math.random());for(;9<=e&&e<=11&&4<=t&&t<=5;)e=Math.floor(20*Math.random()),t=Math.floor(11*Math.random());return{x:e,y:t}}function ce(e,t){if(ee>0&&(ee-=t),Z>0){let e=1-Z/3e3,a=i(s(q)),o=i(s(Q));e<.5?j.x=(2*a+800+700)*Math.sin(e*Math.PI)/2-800:(x&&(D.some(e=>e.x===q&&e.y===Q)||he(q,Q,B),x=!1,setTimeout(()=>{ie()},18e4+12e4*Math.random())),j.x=(2*a+800+700)/2-800+4220*(1-Math.sin(e*Math.PI))/2),j.y=o-100+10*Math.sin(Z/80),Z-=t}for(let e in W){let a=W[e],o=e===H,n=a.isBoss,r=a.sprite.position.x,s=a.sprite.position.y;if(ComfyNetwork.isServer)if(a.path.length>0)if(a.sprite.animations[a.sprite.currentAnimation].playing||Unicorn.PlayObjectAnimation("player_"+e,a.sprite.currentAnimation),a.progress+=t/1e3*(a.isReturningToBase?10:n?.75:o?1.5:1),a.progress>=1){a.progress=0,a.x=a.path[0].x,a.y=a.path[0].y;let e=c(a.x),t=c(a.y);if(k);else if(n);else if(o);else if(!a.isReturningToBase){for(let o=0;o<D.length;o++)D[o].x===e&&D[o].y===t&&(a.points+=d.prizes[D[o].type],console.log(a.name+" GOT THE PRIZE AND NOW HAS "+a.points+" points!"),Unicorn.RemoveObject(D[o].sprite.label),D[o].type!==B&&setTimeout(()=>{he()},1e3*(d.prizeRespawnTime||0)),D.splice(o,1),me());for(let o=0;o<T.length;o++)T[o].x===e&&T[o].y===t&&(a.points+=d.traps[T[o].type],console.log(a.name+" HIT A TRAP AND NOW HAS "+a.points+" points!"),Unicorn.RemoveObject(T[o].sprite.label),T.splice(o,1),fe(),me())}Unicorn.SetPosition(a.sprite.label,i(a.x),i(a.y)),a.sprite.animations[a.sprite.currentAnimation].zIndex=a.sprite.position.y,a.path.shift(),a.path.shift()}else{let e=a.path[0],t=i(a.x)+a.progress*(i(e.x-a.x)-48),o=i(a.y)+a.progress*(i(e.y-a.y)-48);Unicorn.SetPosition(a.sprite.label,t,o),a.sprite.animations[a.sprite.currentAnimation].zIndex=a.sprite.position.y;let r=c(l(t)+1),s=c(l(o)+1);!n&&R[20*s+r].alpha>0&&(R[20*s+r].alpha=Math.min(1-a.progress,R[20*s+r].alpha))}else n&&ye(e),a.isReturningToBase&&(a.isReturningToBase=!1),Unicorn.StopObjectAnimation("player_"+e);if(!k&&n&&ee<=0)for(let t in W){let o=W[t];if(t!==e&&!o.isBoss&&Math.abs(a.sprite.position.x-o.sprite.position.x)<32&&Math.abs(a.sprite.position.y-o.sprite.position.y)<32)switch(g){case"steal":if(W[t].points>0){let a=Math.min(200,Math.ceil((.1+.4*Math.random())*W[t].points));W[t].points-=a,W[e].points+=a}ee=5e3;break;case"base":if(!o.isReturningToBase){let e=c(o.x),a=c(o.y);if(!(9<=e&&e<=11&&4<=a&&a<=5)){o.path=[];let e=["E10","E11","E12","F10","F11","F12"];ue(t,e[Math.floor(Math.random()*e.length)]),o.isReturningToBase=!0}}break;case"death":W[t].hp>0&&(W[t].hp=0,o.path=[],console.log(o),Unicorn.PlayObjectAnimation("player_"+t,"death"))}}if(!k&&o)for(let t in W){let o=W[t];t!==e&&o.x===a.x&&o.y===a.y&&o.x!==X&&o.y!==J&&(X=o.x,J=o.y,H=t,console.log("TAG!",H))}a.label.x=a.sprite.position.x,a.label.x<a.label.width/2+50&&(a.label.x=a.label.width/2+50),a.label.y=a.sprite.position.y-60,a.label.y<80&&(a.label.y=80),a.label.anchor.set(.5),o&&(v.x=a.sprite.position.x,v.y=a.sprite.position.y-30),a.scoreLabel.x=a.label.x,a.scoreLabel.y=a.label.y-(a.label.y<=80?-30:30),a.scoreLabel.text=0===a.points?"":a.points,a.scoreLabel.anchor.set(.5),e===K&&(_.x=a.label.x-a.label.width/2-20,_.y=a.label.y-5);let p="front";a.sprite.position.x<r?p="left":a.sprite.position.x>r?p="right":a.sprite.position.y<s&&(p="back"),a.hp>0&&a.direction!==p&&Unicorn.PlayObjectAnimation("player_"+e,p),a.direction=p,C[e]&&(C[e].position.x=a.sprite.position.x,C[e].position.y=a.sprite.position.y),a.isReturningToBase?a.sprite.animations[a.sprite.currentAnimation].alpha=.25:a.sprite.animations[a.sprite.currentAnimation].alpha=1}d.lightCharacters&&app.renderer.render($,U),ComfyNetwork.isServer&&function(){let e={};for(let t in W){let a=W[t];e[t]={name:a.name,score:a.points,hp:a.hp,isBoss:a.isBoss,character:a.character,x:a.sprite.position.x,y:a.sprite.position.y,dir:a.direction}}let t=[];D.forEach(e=>{t.push({x:e.x,y:e.y,type:e.type})});let a=[];T.forEach(e=>{a.push({x:e.x,y:e.y,type:e.type})});let o={players:e,prizes:t,traps:a};ComfyNetwork.send(o)}()}function pe(){let e=R[Math.floor(Math.random()*R.length)];if(Math.random()>.15){let t=setInterval(()=>{e.alpha-=.01,e.alpha<=0&&clearInterval(t)},10)}else{let t=setInterval(()=>{e.alpha+=.01,e.alpha>=1&&clearInterval(t)},10)}}function fe(){let e=le(),t=e.x,a=e.y;for(let e=0;e<1e4&&D.some(e=>e.x===t&&e.y===a)||T.some(e=>e.x===t&&e.y===a);e++){let o=le();if(t=o.x,a=o.y,e>=9999)return}let o=i(s(t)),n=i(s(a)),r=z[Math.floor(Math.random()*z.length)],l=Unicorn.AddObject("trap"+I++,{type:"circle",sprite:r,x:o,y:n,radius:24,isStatic:!0});l.sprite.scale.x=3,l.sprite.scale.y=3,T.push({x:t,y:a,type:r,sprite:l})}function he(e=-1,t=-1,a=null){if(e<0||t<0){let a=le();e=a.x,t=a.y;for(let a=0;a<1e4&&D.some(a=>a.x===e&&a.y===t)||T.some(a=>a.x===e&&a.y===t);a++){let o=le();if(e=o.x,t=o.y,a>=9999)return}}let o=i(s(e)),n=i(s(t));a||(a=N[Math.floor(Math.random()*N.length)]);let r=null;if(d.animatedPrizes&&d.animatedPrizes[a]){let e={},t="prize"+I;if(d.animatedPrizes[a].appears){e.appears={framerate:.1,frames:[],loop:!1,onComplete:()=>{Unicorn.PlayObjectAnimation(t,"shine")}};for(let t=0;t<d.animatedPrizes[a].appears;t++)e.appears.frames.push(`${a}_appears${t}`)}if(d.animatedPrizes[a].shine){e.shine={framerate:.1,frames:[],loop:!0};for(let t=0;t<d.animatedPrizes[a].shine;t++)e.shine.frames.push(`${a}_shine${t}`)}else e.shine={framerate:.1,frames:[a],loop:!0};r=Unicorn.AddObject("prize"+I++,{type:"circle",animations:e,x:o,y:n,z:1,radius:24,scale:{x:3,y:3},isStatic:!0})}else r=Unicorn.AddObject("prize"+I++,{type:"circle",sprite:a,x:o,y:n,z:1,radius:24,scale:{x:3,y:3},isStatic:!0});D.push({x:e,y:t,type:a,sprite:r})}function de(){ue(u+ ++I,Object.keys(p)[Math.floor(Math.random()*Object.keys(p).length)],d.defaultNameColor||"#ffffff",d.bossCharacter,!0)}function ye(e){ue(e,Object.keys(p)[Math.floor(Math.random()*Object.keys(p).length)],d.defaultNameColor||"#ffffff",d.bossCharacter,!0)}function me(){let e=Object.keys(W).filter(e=>!W[e].isBoss).map(e=>{return{score:W[e].points,name:(t=W[e].name,a=11,t.length>a?t.substring(0,a)+"…":t),fullName:W[e].name};var t,a});e.sort((e,t)=>t.score-e.score);let t=e;S.text=t.map(e=>e.name+": "+e.score).slice(0,14).join("\n"),t.length>0&&t[0].score>0?K=t[0].fullName:(K=null,_.x=-1e3,_.y=-1e3)}function ue(t,a,o="#ffffff",n="",i=!1){me();let l=-1,c=-1;if(f(a)){let e=p[a.toUpperCase()];l=e.x,c=e.y}if(l>=0&&c>=0&&l<20&&c<11){let a,p;if(te.forEach(e=>{Unicorn.RemoveObject(e.label)}),te=[],W[t]){if(W[t].isReturningToBase)return;if(W[t].hp<=0)return;if(W[t].path.length>0?(a=W[t].path[0].x,p=W[t].path[0].y):(W[t].progress=1,a=W[t].x,p=W[t].y),d.characters[n]&&W[t].character!==n){console.log(W[t]);let e={front:[],back:[],left:[],right:[]};if("ghost"===n)for(let t=0;t<18;t++)Object.keys(e).forEach(a=>{e[a].push(d.characters[n]+t)});else for(let t=0;t<10;t++)Object.keys(e).forEach(a=>{e[a].push(d.characters[n]+"_"+a+t)});e.death=["tombstone"];let a=16/60;i&&(a=.2),W[t].isReturningToBase&&(a=160/60);let o=W[t].sprite.position.x,r=W[t].sprite.position.y;Unicorn.RemoveObject("player_"+t),W[t].sprite=Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:3,y:3},animations:{front:{framerate:a,frames:e.front,loop:!0},back:{framerate:a,frames:e.back,loop:!0},left:{framerate:a,frames:e.left,loop:!0},right:{framerate:a,frames:e.right,loop:!0},death:{framerate:a,frames:e.death,loop:!0}},x:o,y:r,z:100,radius:24,isStatic:!0}),W[t].character=n}}else{d.characters[n]&&(i||n!==d.bossCharacter)||(n=d.playable[Math.floor(d.playable.length*Math.random())]),Object.keys(W).length===(y.addBoss?1:0)&&(setTimeout(()=>{let e=setInterval(()=>{A.alpha-=.01,w.alpha-=.01,A.alpha<=0&&clearInterval(e)},10)},5e3),d.giftDrop&&setTimeout(()=>{ie()},12e4+12e4*Math.random())),a=s(10),p=s(5);let e={front:[],back:[],left:[],right:[]};if("ghost"===n)for(let t=0;t<18;t++)Object.keys(e).forEach(a=>{e[a].push(d.characters[n]+t)});else for(let t=0;t<10;t++)Object.keys(e).forEach(a=>{e[a].push(d.characters[n]+"_"+a+t)});e.death=["tombstone"];let r=16/60;i&&(r=.2);let l=Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:3,y:3},animations:{front:{framerate:r,frames:e.front,loop:!0},back:{framerate:r,frames:e.back,loop:!0},left:{framerate:r,frames:e.left,loop:!0},right:{framerate:r,frames:e.right,loop:!0},death:{framerate:r,frames:e.death,loop:!0}},x:-1e3,y:-1e3,z:100,radius:24,isStatic:!0}),c=tinycolor(o);if("boybear"===n||"girlbear"===n){let e=PIXI.utils.string2hex(c.brighten(50).toHexString());l.animations.front.tint=e,l.animations.back.tint=e,l.animations.left.tint=e,l.animations.right.tint=e}if(W[t]={name:t,isBoss:i,x:a,y:p,progress:1,path:[],points:0,hp:100,label:Unicorn.AddText(t,i?u:t,-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:40,fontWeight:"bold",fill:o,lineJoin:"round",stroke:c.getLuminance()<.6?d.defaultNameColor||"#ffffff":d.scoreColor||"#000000",strokeThickness:6}),scoreLabel:Unicorn.AddText(t+"_points","0",-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:40,fontWeight:"bold",fill:d.scoreColor||"#000000",lineJoin:"round",stroke:d.defaultNameColor||"#ffffff",strokeThickness:6}),sprite:l,character:n},d.lightCharacters){C[t]=PIXI.Sprite.from(`${m}/assets/effects/light_glow.png`),C[t].scale={x:10,y:10},C[t].anchor.set(.5);let e=PIXI.utils.string2hex(c.brighten(60).toHexString());C[t].tint=e,$.addChild(C[t])}}let f=function(t,a,o,n,r,s,i){if(n===s&&r===i)return[{x:n,y:r}];if(n<0||n>=a||r<0||r>=o)return null;if(t[r*a+n]>0)return null;let l=[{x:n,y:r,score:e(n,r,s,i),path:[]}],c=t.slice();for(;l.length>0;){let t=l.shift();if(t.x===s&&t.y===i)return t.path.concat({x:t.x,y:t.y});if(t.x<0||t.x>=a||t.y<0||t.y>=o);else if(c[t.y*a+t.x]>0);else{c[t.y*a+t.x]=2;let o=t.path.concat({x:t.x,y:t.y});l.push({x:t.x,y:t.y-1,score:e(t.x,t.y-1,s,i),path:o}),l.push({x:t.x+1,y:t.y,score:e(t.x+1,t.y,s,i),path:o}),l.push({x:t.x,y:t.y+1,score:e(t.x,t.y+1,s,i),path:o}),l.push({x:t.x-1,y:t.y,score:e(t.x-1,t.y,s,i),path:o}),l.sort((t,a)=>e(t.x,t.y,s,i)-e(a.x,a.y,s,i)+t.path.length-a.path.length)}}return null}(r,41,23,a,p,s(l),s(c));W[t].path=f}}function ge(e,t,a,o,n){if(!k&&"play"===t){G[e]=!0;let t=["E10","E11","E12","F10","F11","F12"];ue(e,t[Math.floor(Math.random()*t.length)],n.userColor||d.defaultNameColor||"#ffffff",a.toLowerCase())}if(o.broadcaster||o.mod||o.vip){if("starttag"!==t&&"tag"!==t||(H=Object.keys(W)[Math.floor(Math.random()*Object.keys(W).length)]),k||"prize"!==t||he(),"end"===t){k=!0,setInterval(()=>{for(let e=0;e<Y.length;e++)Y[e].alpha=0;V=(V+1)%Y.length;let e=Math.floor(Y.length*Math.random());Y[e].alpha=1},300),Y[0].alpha=1,L.alpha=1,P.alpha=1,E.alpha=1,S.alpha=1;for(let e in W){let t=W[e];t.label.alpha=0,t.scoreLabel.alpha=0}let e=-1;if(a&&(e=parseInt(a)),y.messageFormat){let t=y.messageFormat,a=Object.keys(W).filter(e=>!W[e].isBoss).map(e=>({score:W[e].points,name:W[e].name}));a.sort((e,t)=>t.score-e.score),e>0&&(a=a.slice(0,e)),a.forEach(e=>{if(e.score>0&&e.name!==u){let a=t.replace("USERNAME",e.name).replace("POINTS",e.score);ComfyJS.Say(a)}})}}"reset"!==t&&"restart"!==t&&"refresh"!==t||location.reload()}}function xe(e,t,a,o,n){!k&&f(t)&&(G[e]=!0,ue(e,t,n.userColor||d.defaultNameColor||"#ffffff"))}function be(){let e=Object.keys(G).length;fetch(`https://api.instafluff.tv:8082/report?game=${h}&channel=${y.channel}&players=${e}`).then(e=>e.json()).then(e=>{0===e.status&&console.log("Error:",e.message)})}window.setupGame=function(e,t,a){h=e,d=t,y=a,y.roomCode?(ComfyNetwork.join(y.roomCode),ComfyNetwork.onData=(e,t)=>{for(let e in t.players){let a=t.players[e];W[e]||(a.isBoss?ye(e):ue(e,"A1",d.defaultNameColor||"#ffffff",a.character),W[e].path=[],console.log("adding player",e));let o=W[e];o.name=a.name,o.character=a.character,o.points=a.score,o.hp=a.hp,o.isBoss=a.isBoss,o.sprite.position.x=a.x,o.sprite.position.y=a.y,o.direction=a.dir,0===o.hp&&Unicorn.PlayObjectAnimation("player_"+e,"death")}}):(ComfyNetwork.start(),ComfyNetwork.onData=(e,t)=>{ue(e,t,"#ffffff")}),u=d.bossName,m=d.path||"",Object.keys(d.trapRarity).forEach(e=>{for(let t=0;t<d.trapRarity[e];t++)z.push(e)}),y.giftDrop&&(B=y.giftDrop),Object.keys(d.prizeRarity).forEach(e=>{if(e!==B)for(let t=0;t<d.prizeRarity[e];t++)N.push(e)}),b=Math.max(0,Math.min(214,y.numPrizes)),M=Math.max(0,Math.min(214,y.numTraps)),O=y.numBosses||1,g=y.bossEffect||"steal"};let Me=new Peer(null,{debug:2});function Oe(e,t=!1){Ue.isServer=t,Me.on("open",(function(t){if(null===Me.id?Me.id=Ue.id:Ue.id=Me.id,console.log("ID:",Ue.id),!Ue.isServer){console.log("connecting...");let t=Me.connect(e,{metadata:{username:"test name"}});t.on("data",(function(e){Ue.onData&&Ue.onData(t.peer,e)})),t.on("open",(function(){console.log(t.peer,"ready"),Ue.peers[t.peer]=t,Ue.onJoin&&Ue.onJoin(t.peer)})),t.on("close",(function(){console.log(t.peer,"closed"),delete Ue.peers[t.peer],Ue.onLeave&&Ue.onLeave(t.peer)})),t.on("error",(function(e){console.log(t.peer,e)}))}})),Me.on("connection",(function(e){Ue.peers[e.peer]&&console.log(e.peer,"was already connected..."),console.log(e.peer,e.label,e.metadata),e.on("data",(function(t){console.log(e.peer,"received",t),Ue.onData&&Ue.onData(e.peer,t)})),e.on("open",(function(){console.log(e.peer,"ready"),Ue.peers[e.peer]=e,Ue.onJoin&&Ue.onJoin(e.peer)})),e.on("close",(function(){console.log(e.peer,"closed"),delete Ue.peers[e.peer],Ue.onLeave&&Ue.onLeave(e.peer)})),e.on("error",(function(t){console.log(e.peer,t)}))})),Me.on("close",(function(){Ue.onDisconnect&&Ue.onDisconnect()})),Me.on("disconnected",(function(){})),Me.on("error",(function(e){e.type,console.log(e)}))}let Ue={id:null,isServer:!1,peers:{},start:()=>{Oe(null,!0)},join:e=>{Oe(e,!1)},send:function(e){Object.keys(Ue.peers).forEach(t=>{Ue.peers[t].open&&Ue.peers[t].send(e)})},onJoin:null,onData:null,onLeave:null,onDisconnect:null};window.ComfyNetwork=Ue;