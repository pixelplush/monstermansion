function e(e,t,o,a){return Math.abs(o-e)+Math.abs(a-t)}let t=[1,9,0,0,1,0,1,0,9,0,0,1,0,0,0,0,1,9,1,0,1,1,1,0,1,9,0,0,1,0,0,1,9,1,0,0,0,1,1,9,0,1,1,9,1,1,0,0,0,1,1,0,9,0,9,0,1,1,1,0,1,0,1,1,1,9,0,1,0,1,1,0,1,9,1,0,9,0,9,1,1,9,1,1,1,0,9,9,1,9,1,9,1,9,0,0,1,9,0,1,9,1,0,1,1,1,0,1,1,1,1,1,1,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,9,1,9,1,1,1,1,9,0,9,0,1,0,9,0,0,1,0,1,1,1,1,0,0,1,0,0,1,1,0,0,0,1,1,1,1,9,9,1,1,1,9,1,0,9,9,1,0,9,1,9,0,0,0,9,0,0,9,1,1,1,1,1,9,0,1,9,0,9,0,0,1,1,1,0,1,0,1,0,0,9,1,1,0,0,1,0,0,9,0,1,0,9,1,0,0,1,0,1,0,9,0,1],o=[1,0,1,9,0,1,9,9,1,1,9,9,0,1,9,1,1,0,0,1,0,1,1,0,9,0,9,1,1,9,0,1,1,0,1,1,1,9,0,0,1,1,9,1,1,0,1,9,1,1,9,0,0,9,1,9,1,1,0,0,1,9,0,0,9,1,1,0,1,0,1,1,0,9,1,0,0,1,9,1,1,1,0,0,1,0,0,1,1,9,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,1,1,0,1,9,0,0,9,0,0,9,0,1,0,0,9,1,1,1,9,9,1,1,1,0,9,0,1,0,0,1,9,1,1,1,1,9,0,0,0,1,0,1,0,1,1,1,0,1,1,0,0,1,1,0,9,1,1,1,9,1,0,1,1,0,9,1,1,0,0,0,0,0,1,0,1,1,0,9,9,1,1,1,9,1,1,9,9,1,1,9,1,9,0,9,1,1,9,1,1,0,0,1,9,9,1,9,1,1,9,1],a=[];for(let e=0;e<11;e++)for(let o=0;o<21;o++)a.push(t[21*e+o]),o<20&&a.push(0);let n=[];for(let e=0;e<10;e++)for(let t=0;t<22;t++)n.push(o[22*e+t]),t>0&&t<20&&n.push(1);let r=[];for(let e=0;e<41;e++)r.push(1);for(let e=0;e<21;e++)for(let t=0;t<41;t++)e%2==0?r.push(a[41*Math.floor(e/2)+t]):r.push(n[41*Math.floor(e/2)+t]);for(let e=0;e<41;e++)r.push(1);function s(e){return 1+2*e}function i(e){return 96*Math.floor(e/2)+48}function l(e){return 2*Math.floor(e/96)+1}function c(e){return Math.floor((e-1)/2)}const p={};function f(e){return!!p[e.toUpperCase()]}["A","B","C","D","E","F","G","H","I","J","K"].forEach((e,t)=>{for(let o=0;o<20;o++)p[e+(o+1)]={x:o,y:t}}),window.WebFontConfig={custom:{families:["Pixeltype"]},active(){Unicorn.Create("unicorn-display",{width:1920,height:1056,background:"transparent",init:le,update:fe,channel:m.channel,username:m.oauth?m.channel:void 0,password:m.oauth,onCommand:be,onChat:$e,gravity:{x:0,y:0}}),ComfyJS.onConnected=(e,t,o)=>{o&&(setInterval(()=>{Me()},6e4),Me())}}},function(){const e=document.createElement("script");e.src=`${"https:"===document.location.protocol?"https":"http"}://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js`,e.type="text/javascript",e.async="true";const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();let h="Monster Mansion",d={},m={},y="",u="*BOO*",g="steal",x=!0,b=3,$=5,M=1,O=.5,U=PIXI.RenderTexture.create(1920,1080),v=new PIXI.Container,C={},I={};let k=0,w=!1;let S,A,E,P,j,L,_,z,N,B=[],T=[],D="",R=[],F=[],X=[],J=["front","back","left","right"],H=-1,W=-1,G=null,V={},Y={},K=0,Z=[],q=null,Q=0,ee=-1,te=-1;let oe=3e3;r=r.map(e=>9===e?0:e);let ae=[];let ne=!1;function re(e){ne=!0,ie(e)}function se(e){ne=!1}function ie(e){if(ne){let t=e.data.originalEvent.layerX,o=e.data.originalEvent.layerY,a=c(l(t)),n=c(l(o)),r=Object.keys(p).filter(e=>p[e].x===a&&p[e].y===n)[0];ComfyNetwork.isServer?xe(I.login,r,"#ffffff"):ComfyNetwork.send({coord:r,name:I.login})}}function le(){PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,Unicorn.Load("map",`${y}/assets/${d.map}.png`);let e=Unicorn.AddBacklay("map","map",0,-9,{scale:{x:3,y:3}});if(e.interactive=!0,e.buttonMode=!0,e.on("pointerdown",re),e.on("pointerup",se),e.on("pointermove",ie),console.log(e),Unicorn.Load("music",`${y}/assets/${d.music}`),Unicorn.PlaySound("music",{volume:O}),d.lightCharacters){const e=new PIXI.Graphics;e.beginFill(0,.925),e.drawRect(0,0,1920,1080),e.endFill(),v.addChild(e),v.blendMode=PIXI.BLEND_MODES.ADD}Unicorn.Load("light_glow",`${y}/assets/effects/light_glow.png`),Unicorn.Load("glow",`${y}/assets/effects/lantern_glow.png`),Unicorn.Load("tombstone",`${y}/assets/items/${d.deathItem}.png`),d.glows.forEach((e,t)=>{let o=Unicorn.AddOverlay("lantern"+t,"glow",3*e.x,3*e.y);o.anchor.set(.5),o.scale.x=5.5,o.scale.y=5.5;let a=null;d.lightCharacters&&(a=new PIXI.Sprite(assetReference.light_glow),a.position.x=3*e.x,a.position.y=3*e.y,a.scale={x:7,y:7},a.anchor.set(.5),v.addChild(a)),setInterval(()=>{o.alpha=Math.random()<.1?0:1,a&&(a.alpha=o.alpha),setTimeout(()=>{o.alpha=1,a&&(a.alpha=o.alpha)},200+200*Math.random())},500+500*Math.random())}),Unicorn.Load("walls",`${y}/assets/${d.walls}.png`);let t=Unicorn.AddOverlay("walls","walls",0,0);if(t.scale.x=3,t.scale.y=3,d.lanterns){Unicorn.Load("lanterns",`${y}/assets/${d.lanterns}.png`);let e=Unicorn.AddOverlay("lanterns","lanterns",0,0);e.scale.x=3,e.scale.y=3}d.fog.forEach((e,t)=>{Unicorn.Load(`fog${t}`,`${y}/assets/${e}.png`)});for(let e=0;e<11;e++)for(let t=0;t<20;t++){let o=i(s(t)),a=i(s(e)),n="fog"+Math.floor(Math.random()*d.fog.length),r=Unicorn.AddOverlay("fog"+t+"_"+e,n,o,a,{z:1});r.scale.x=3,r.scale.y=3,r.anchor.set(.5),8<t&&t<12&&3<e&&e<6&&(r.alpha=0),Math.random()>.15&&(r.alpha=0),X.push(r)}setInterval(he,1e3),d.numbers?Unicorn.Load("guide",`${y}/assets/${d.numbers}.png`):Unicorn.Load("guide",`${y}/assets/numbers_g.png`);let o=Unicorn.AddOverlay("guide","guide",0,0);o.scale.x=3,o.scale.y=3,Object.keys(d.prizes).forEach(e=>{d.animatedPrizes&&d.animatedPrizes[e]&&Object.keys(d.animatedPrizes[e]).forEach(t=>{for(let o=0;o<d.animatedPrizes[e][t];o++)Unicorn.Load(`${e}_${t}${o}`,`${y}/assets/items/${e}_${t}/${e}_${t}${o+1}.png`)}),Unicorn.Load(e,`${y}/assets/items/${e}.png`)}),Object.keys(d.traps).forEach(e=>{Unicorn.Load(e,`${y}/assets/items/${e}.png`)});for(let e in d.characters)if("ghost"===e){let t=d.characters[e];for(let o=1;o<19;o++)Unicorn.Load(t+(o-1),`${y}/assets/characters/${e}/${t}${o}.png`)}else J.forEach(t=>{let o=d.characters[e]+"_"+t;for(let t=1;t<11;t++)Unicorn.Load(o+(t-1),`${y}/assets/characters/${e}/${o}/${o}${t}.png`)});if(Unicorn.Load("star_blue",`${y}/assets/icons/star_blue.png`),S=Unicorn.AddOverlay("tagStar","star_blue",-1e3,-1e3),S.scale.x=3,S.scale.y=3,S.anchor.set(.5),Unicorn.Load("star",`${y}/assets/icons/star.png`),z=Unicorn.AddOverlay("star","star",-1e3,-1e3),z.scale.x=3,z.scale.y=3,z.anchor.set(.5),Unicorn.Load("start",`${y}/assets/${d.instructions}.png`),A=Unicorn.AddOverlay("gameStart","start",50,50,{z:100}),A.scale.x=3,A.scale.y=3,m.showBannerAd&&Unicorn.Load("banner_ad",`${y}/assets/banner.png`),E=Unicorn.AddOverlay("banner_ad","banner_ad",1360,50,{z:101}),E.scale.x=3,E.scale.y=3,d.sleigh&&(Unicorn.Load("sleigh",`${y}/assets/${d.sleigh}.png`),N=Unicorn.AddOverlay("santaSleigh","sleigh",0,-1e3,{z:10}),N.scale.x=3,N.scale.y=3),Unicorn.Load("end_bg",`${y}/assets/${d.endBG}.png`),P=Unicorn.AddOverlay("end_bg","end_bg",0,0,{z:100}),P.scale.x=3,P.scale.y=3,P.alpha=0,d.scoreBoard.forEach((e,t)=>{Unicorn.Load(`scoreboard${t}`,`${y}/assets/${e}.png`);let o=Unicorn.AddOverlay("scoreboard","scoreboard"+t,1280,d.scoreBoardVerticalOffset,{z:100});o.scale.x=3,o.scale.y=3,o.alpha=0,Z.push(o)}),Unicorn.Load("end_sign",`${y}/assets/${d.banner}.png`),L=Unicorn.AddOverlay("end_sign","end_sign",250+(d.bannerHorizontalOffset?d.bannerHorizontalOffset:0),50,{z:110}),L.scale.x=3,L.scale.y=3,L.alpha=0,Unicorn.Load("end_note",`${y}/assets/${d.endNote}.png`),j=Unicorn.AddOverlay("end_note","end_note",200,400+(d.endVerticalOffset?d.endVerticalOffset:0),{z:100}),j.scale.x=3,j.scale.y=3,j.alpha=0,_=Unicorn.AddText("scores","Scores:",1400,250,{fontFamily:"Pixeltype",fontSize:50,fontWeight:"bold",fill:d.scoreboardColor||"#ffffff",z:100}),_.alpha=0,ComfyNetwork.isServer){for(let e=0;e<b;e++)me();for(let e=0;e<$;e++)de();if(m.addBoss)for(let e=0;e<M;e++)setTimeout(ye,1e3*e)}if(d.snow&&Unicorn.AddParticles("snowupdown",{blendMode:PIXI.BLEND_MODES.DEFAULT,shape:"line",angle:Math.PI/2,startColor:"#ffffff",endColor:"#ffffff",intensity:2,minSpeed:.05,maxSpeed:.2,decay:15},0,-200),d.lightCharacters){app.stage.addChild(o);let e=PIXI.Sprite.from(U);e.blendMode=PIXI.BLEND_MODES.MULTIPLY,groupOverlay.addChild(e);let t=new PIXI.SpriteMaskFilter(PIXI.Sprite.from(U));t.blendMode=PIXI.BLEND_MODES.OVERLAY,groupWorld.filters=[t]}}function ce(){x=!0;let e=pe();ee=e.x,te=e.y,Q=3e3}function pe(){let e=Math.floor(20*Math.random()),t=Math.floor(11*Math.random());for(;9<=e&&e<=11&&4<=t&&t<=5;)e=Math.floor(20*Math.random()),t=Math.floor(11*Math.random());return{x:e,y:t}}function fe(e,t){if(oe>0&&(oe-=t),Q>0){let e=1-Q/3e3,o=i(s(ee)),a=i(s(te));e<.5?N.x=(2*o+800+700)*Math.sin(e*Math.PI)/2-800:(x&&(F.some(e=>e.x===ee&&e.y===te)||me(ee,te,D),x=!1,setTimeout(()=>{ce()},18e4+12e4*Math.random())),N.x=(2*o+800+700)/2-800+4220*(1-Math.sin(e*Math.PI))/2),N.y=a-100+10*Math.sin(Q/80),Q-=t}for(let e in V){let o=V[e],a=e===G,n=o.isBoss,r=o.sprite.position.x,s=o.sprite.position.y;if(ComfyNetwork.isServer)if(o.path.length>0)if(o.sprite.animations[o.sprite.currentAnimation].playing||Unicorn.PlayObjectAnimation("player_"+e,o.sprite.currentAnimation),o.progress+=t/1e3*(o.isReturningToBase?10:n?.75:a?1.5:1),o.progress>=1){o.progress=0,o.x=o.path[0].x,o.y=o.path[0].y;let e=c(o.x),t=c(o.y);if(w);else if(n);else if(a);else if(!o.isReturningToBase){for(let a=0;a<F.length;a++)F[a].x===e&&F[a].y===t&&(o.points+=d.prizes[F[a].type],console.log(o.name+" GOT THE PRIZE AND NOW HAS "+o.points+" points!"),Unicorn.RemoveObject(F[a].sprite.label),F[a].type!==D&&setTimeout(()=>{me()},1e3*(d.prizeRespawnTime||0)),F.splice(a,1),ge());for(let a=0;a<R.length;a++)R[a].x===e&&R[a].y===t&&(o.points+=d.traps[R[a].type],console.log(o.name+" HIT A TRAP AND NOW HAS "+o.points+" points!"),Unicorn.RemoveObject(R[a].sprite.label),R.splice(a,1),de(),ge())}Unicorn.SetPosition(o.sprite.label,i(o.x),i(o.y)),o.sprite.animations[o.sprite.currentAnimation].zIndex=o.sprite.position.y,o.path.shift(),o.path.shift()}else{let e=o.path[0],t=i(o.x)+o.progress*(i(e.x-o.x)-48),a=i(o.y)+o.progress*(i(e.y-o.y)-48);Unicorn.SetPosition(o.sprite.label,t,a),o.sprite.animations[o.sprite.currentAnimation].zIndex=o.sprite.position.y;let r=c(l(t)+1),s=c(l(a)+1);!n&&X[20*s+r].alpha>0&&(X[20*s+r].alpha=Math.min(1-o.progress,X[20*s+r].alpha))}else n&&ue(e),o.isReturningToBase&&(o.isReturningToBase=!1),Unicorn.StopObjectAnimation("player_"+e);if(!w&&n&&oe<=0)for(let t in V){let a=V[t];if(t!==e&&!a.isBoss&&Math.abs(o.sprite.position.x-a.sprite.position.x)<32&&Math.abs(o.sprite.position.y-a.sprite.position.y)<32)switch(g){case"steal":if(V[t].points>0){let o=Math.min(200,Math.ceil((.1+.4*Math.random())*V[t].points));V[t].points-=o,V[e].points+=o}oe=5e3;break;case"base":if(!a.isReturningToBase){let e=c(a.x),o=c(a.y);if(!(9<=e&&e<=11&&4<=o&&o<=5)){a.path=[];let e=["E10","E11","E12","F10","F11","F12"];xe(t,e[Math.floor(Math.random()*e.length)]),a.isReturningToBase=!0}}break;case"death":V[t].hp>0&&(V[t].hp=0,a.path=[],console.log(a),Unicorn.PlayObjectAnimation("player_"+t,"death"))}}if(!w&&a)for(let t in V){let a=V[t];t!==e&&a.x===o.x&&a.y===o.y&&a.x!==H&&a.y!==W&&(H=a.x,W=a.y,G=t,console.log("TAG!",G))}o.label.x=o.sprite.position.x,o.label.x<o.label.width/2+50&&(o.label.x=o.label.width/2+50),o.label.y=o.sprite.position.y-60,o.label.y<80&&(o.label.y=80),o.label.anchor.set(.5),a&&(S.x=o.sprite.position.x,S.y=o.sprite.position.y-30),o.scoreLabel.x=o.label.x,o.scoreLabel.y=o.label.y-(o.label.y<=80?-30:30),o.scoreLabel.text=0===o.points?"":o.points,o.scoreLabel.anchor.set(.5),e===q&&(z.x=o.label.x-o.label.width/2-20,z.y=o.label.y-5);let p="front";o.sprite.position.x<r?p="left":o.sprite.position.x>r?p="right":o.sprite.position.y<s&&(p="back"),o.hp>0&&o.direction!==p&&Unicorn.PlayObjectAnimation("player_"+e,p),o.direction=p,C[e]&&(C[e].position.x=o.sprite.position.x,C[e].position.y=o.sprite.position.y),o.isReturningToBase?o.sprite.animations[o.sprite.currentAnimation].alpha=.25:o.sprite.animations[o.sprite.currentAnimation].alpha=1}d.lightCharacters&&app.renderer.render(v,U),ComfyNetwork.isServer&&function(){let e={};for(let t in V){let o=V[t];e[t]={name:o.name,score:o.points,hp:o.hp,isBoss:o.isBoss,character:o.character,x:o.sprite.position.x,y:o.sprite.position.y,dir:o.direction}}let t=[];F.forEach(e=>{t.push({x:e.x,y:e.y,type:e.type})});let o=[];R.forEach(e=>{o.push({x:e.x,y:e.y,type:e.type})});let a={players:e,prizes:t,traps:o};ComfyNetwork.send(a)}()}function he(){let e=X[Math.floor(Math.random()*X.length)];if(Math.random()>.15){let t=setInterval(()=>{e.alpha-=.01,e.alpha<=0&&clearInterval(t)},10)}else{let t=setInterval(()=>{e.alpha+=.01,e.alpha>=1&&clearInterval(t)},10)}}function de(){let e=pe(),t=e.x,o=e.y;for(let e=0;e<1e4&&F.some(e=>e.x===t&&e.y===o)||R.some(e=>e.x===t&&e.y===o);e++){let a=pe();if(t=a.x,o=a.y,e>=9999)return}let a=i(s(t)),n=i(s(o)),r=B[Math.floor(Math.random()*B.length)],l=Unicorn.AddObject("trap"+k++,{type:"circle",sprite:r,x:a,y:n,radius:24,isStatic:!0});l.sprite.scale.x=3,l.sprite.scale.y=3,R.push({x:t,y:o,type:r,sprite:l})}function me(e=-1,t=-1,o=null){if(e<0||t<0){let o=pe();e=o.x,t=o.y;for(let o=0;o<1e4&&F.some(o=>o.x===e&&o.y===t)||R.some(o=>o.x===e&&o.y===t);o++){let a=pe();if(e=a.x,t=a.y,o>=9999)return}}let a=i(s(e)),n=i(s(t));o||(o=T[Math.floor(Math.random()*T.length)]);let r=null;if(d.animatedPrizes&&d.animatedPrizes[o]){let e={},t="prize"+k;if(d.animatedPrizes[o].appears){e.appears={framerate:.1,frames:[],loop:!1,onComplete:()=>{Unicorn.PlayObjectAnimation(t,"shine")}};for(let t=0;t<d.animatedPrizes[o].appears;t++)e.appears.frames.push(`${o}_appears${t}`)}if(d.animatedPrizes[o].shine){e.shine={framerate:.1,frames:[],loop:!0};for(let t=0;t<d.animatedPrizes[o].shine;t++)e.shine.frames.push(`${o}_shine${t}`)}else e.shine={framerate:.1,frames:[o],loop:!0};r=Unicorn.AddObject("prize"+k++,{type:"circle",animations:e,x:a,y:n,z:1,radius:24,scale:{x:3,y:3},isStatic:!0})}else r=Unicorn.AddObject("prize"+k++,{type:"circle",sprite:o,x:a,y:n,z:1,radius:24,scale:{x:3,y:3},isStatic:!0});F.push({x:e,y:t,type:o,sprite:r})}function ye(){xe(u+ ++k,Object.keys(p)[Math.floor(Math.random()*Object.keys(p).length)],d.defaultNameColor||"#ffffff",d.bossCharacter,!0)}function ue(e){xe(e,Object.keys(p)[Math.floor(Math.random()*Object.keys(p).length)],d.defaultNameColor||"#ffffff",d.bossCharacter,!0)}function ge(){let e=Object.keys(V).filter(e=>!V[e].isBoss).map(e=>{return{score:V[e].points,name:(t=V[e].name,o=11,t.length>o?t.substring(0,o)+"…":t),fullName:V[e].name};var t,o});e.sort((e,t)=>t.score-e.score);let t=e;_.text=t.map(e=>e.name+": "+e.score).slice(0,14).join("\n"),t.length>0&&t[0].score>0?q=t[0].fullName:(q=null,z.x=-1e3,z.y=-1e3)}function xe(t,o,a="#ffffff",n="",i=!1){ge();let l=-1,c=-1;if(f(o)){let e=p[o.toUpperCase()];l=e.x,c=e.y}if(l>=0&&c>=0&&l<20&&c<11){let o,p;if(ae.forEach(e=>{Unicorn.RemoveObject(e.label)}),ae=[],V[t]){if(V[t].isReturningToBase)return;if(V[t].hp<=0)return;if(V[t].path.length>0?(o=V[t].path[0].x,p=V[t].path[0].y):(V[t].progress=1,o=V[t].x,p=V[t].y),d.characters[n]&&V[t].character!==n){console.log(V[t]);let e={front:[],back:[],left:[],right:[]};if("ghost"===n)for(let t=0;t<18;t++)Object.keys(e).forEach(o=>{e[o].push(d.characters[n]+t)});else for(let t=0;t<10;t++)Object.keys(e).forEach(o=>{e[o].push(d.characters[n]+"_"+o+t)});e.death=["tombstone"];let o=16/60;i&&(o=.2),V[t].isReturningToBase&&(o=160/60);let a=V[t].sprite.position.x,r=V[t].sprite.position.y;Unicorn.RemoveObject("player_"+t),V[t].sprite=Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:3,y:3},animations:{front:{framerate:o,frames:e.front,loop:!0},back:{framerate:o,frames:e.back,loop:!0},left:{framerate:o,frames:e.left,loop:!0},right:{framerate:o,frames:e.right,loop:!0},death:{framerate:o,frames:e.death,loop:!0}},x:a,y:r,z:100,radius:24,isStatic:!0}),V[t].character=n}}else{d.characters[n]&&(i||n!==d.bossCharacter)||(n=d.playable[Math.floor(d.playable.length*Math.random())]),Object.keys(V).length===(m.addBoss?1:0)&&(setTimeout(()=>{let e=setInterval(()=>{A.alpha-=.01,E.alpha-=.01,A.alpha<=0&&clearInterval(e)},10)},5e3),d.giftDrop&&setTimeout(()=>{ce()},12e4+12e4*Math.random())),o=s(10),p=s(5);let e={front:[],back:[],left:[],right:[]};if("ghost"===n)for(let t=0;t<18;t++)Object.keys(e).forEach(o=>{e[o].push(d.characters[n]+t)});else for(let t=0;t<10;t++)Object.keys(e).forEach(o=>{e[o].push(d.characters[n]+"_"+o+t)});e.death=["tombstone"];let r=16/60;i&&(r=.2);let l=Unicorn.AddObject("player_"+t,{type:"circle",scale:{x:3,y:3},animations:{front:{framerate:r,frames:e.front,loop:!0},back:{framerate:r,frames:e.back,loop:!0},left:{framerate:r,frames:e.left,loop:!0},right:{framerate:r,frames:e.right,loop:!0},death:{framerate:r,frames:e.death,loop:!0}},x:-1e3,y:-1e3,z:100,radius:24,isStatic:!0}),c=tinycolor(a);if("boybear"===n||"girlbear"===n){let e=PIXI.utils.string2hex(c.brighten(50).toHexString());l.animations.front.tint=e,l.animations.back.tint=e,l.animations.left.tint=e,l.animations.right.tint=e}if(V[t]={name:t,isBoss:i,x:o,y:p,progress:1,path:[],points:0,hp:100,label:Unicorn.AddText(t,i?u:t,-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:40,fontWeight:"bold",fill:a,lineJoin:"round",stroke:c.getLuminance()<.6?d.defaultNameColor||"#ffffff":d.scoreColor||"#000000",strokeThickness:6}),scoreLabel:Unicorn.AddText(t+"_points","0",-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:40,fontWeight:"bold",fill:d.scoreColor||"#000000",lineJoin:"round",stroke:d.defaultNameColor||"#ffffff",strokeThickness:6}),sprite:l,character:n},d.lightCharacters){C[t]=PIXI.Sprite.from(`${y}/assets/effects/light_glow.png`),C[t].scale={x:10,y:10},C[t].anchor.set(.5);let e=PIXI.utils.string2hex(c.brighten(60).toHexString());C[t].tint=e,v.addChild(C[t])}}let f=function(t,o,a,n,r,s,i){if(n===s&&r===i)return[{x:n,y:r}];if(n<0||n>=o||r<0||r>=a)return null;if(t[r*o+n]>0)return null;let l=[{x:n,y:r,score:e(n,r,s,i),path:[]}],c=t.slice();for(;l.length>0;){let t=l.shift();if(t.x===s&&t.y===i)return t.path.concat({x:t.x,y:t.y});if(t.x<0||t.x>=o||t.y<0||t.y>=a);else if(c[t.y*o+t.x]>0);else{c[t.y*o+t.x]=2;let a=t.path.concat({x:t.x,y:t.y});l.push({x:t.x,y:t.y-1,score:e(t.x,t.y-1,s,i),path:a}),l.push({x:t.x+1,y:t.y,score:e(t.x+1,t.y,s,i),path:a}),l.push({x:t.x,y:t.y+1,score:e(t.x,t.y+1,s,i),path:a}),l.push({x:t.x-1,y:t.y,score:e(t.x-1,t.y,s,i),path:a}),l.sort((t,o)=>e(t.x,t.y,s,i)-e(o.x,o.y,s,i)+t.path.length-o.path.length)}}return null}(r,41,23,o,p,s(l),s(c));V[t].path=f}}function be(e,t,o,a,n){if(!w&&"play"===t){Y[e]=!0;let t=["E10","E11","E12","F10","F11","F12"];xe(e,t[Math.floor(Math.random()*t.length)],n.userColor||d.defaultNameColor||"#ffffff",o.toLowerCase())}if(a.broadcaster||a.mod||a.vip){if("starttag"!==t&&"tag"!==t||(G=Object.keys(V)[Math.floor(Math.random()*Object.keys(V).length)]),w||"prize"!==t||me(),"end"===t){w=!0,setInterval(()=>{for(let e=0;e<Z.length;e++)Z[e].alpha=0;K=(K+1)%Z.length;let e=Math.floor(Z.length*Math.random());Z[e].alpha=1},300),Z[0].alpha=1,L.alpha=1,j.alpha=1,P.alpha=1,_.alpha=1;for(let e in V){let t=V[e];t.label.alpha=0,t.scoreLabel.alpha=0}let e=-1;if(o&&(e=parseInt(o)),m.messageFormat){let t=m.messageFormat,o=Object.keys(V).filter(e=>!V[e].isBoss).map(e=>({score:V[e].points,name:V[e].name}));o.sort((e,t)=>t.score-e.score),e>0&&(o=o.slice(0,e)),o.forEach(e=>{if(e.score>0&&e.name!==u){let o=t.replace("USERNAME",e.name).replace("POINTS",e.score);ComfyJS.Say(o)}})}}"reset"!==t&&"restart"!==t&&"refresh"!==t||location.reload()}}function $e(e,t,o,a,n){!w&&f(t)&&(Y[e]=!0,xe(e,t,n.userColor||d.defaultNameColor||"#ffffff"))}function Me(){let e=Object.keys(Y).length;fetch(`https://api.instafluff.tv:8082/report?game=${h}&channel=${m.channel}&players=${e}`).then(e=>e.json()).then(e=>{0===e.status&&console.log("Error:",e.message)})}window.setupGame=function(e,t,o){h=e,d=t,m=o,fetch(`${m.roomServer}/joinroom?twitch=${m.roomToken}&game=${h}&room=${m.roomName}&pass=${m.roomPass}`).then(e=>e.json()).then(e=>{console.log(e),e&&!e.error?(I=e.user,m.roomCode=e.code,m.roomCode?(ComfyNetwork.join(m.roomCode),ComfyNetwork.onData=(e,t)=>{for(let e in t.players){let o=t.players[e];V[e]||(o.isBoss?ue(e):xe(e,"A1",d.defaultNameColor||"#ffffff",o.character),V[e].path=[],console.log("adding player",e));let a=V[e];a.name=o.name,a.character=o.character,a.points=o.score,a.hp=o.hp,a.isBoss=o.isBoss,a.sprite.position.x=o.x,a.sprite.position.y=o.y,a.direction=o.dir,0===a.hp&&Unicorn.PlayObjectAnimation("player_"+e,"death")}}):(ComfyNetwork.start(),ComfyNetwork.onStart=e=>{fetch(`${m.roomServer}/joinroom?twitch=${m.roomToken}&game=${h}&room=${m.roomName}&pass=${m.roomPass}&code=${e}`).then(e=>e.json()).then(e=>{console.log("Code Set!",e),setInterval(()=>{fetch(`${m.roomServer}/refresh?game=${h}&room=${m.roomName}&pass=${m.roomPass}`).then(e=>e.json()).then(e=>{console.log("Refreshed",e)})},3e4)})},ComfyNetwork.onData=(e,t)=>{xe(t.name,t.coord,"#ffffff")})):console.log(e.error)}),u=d.bossName,y=d.path||"",Object.keys(d.trapRarity).forEach(e=>{for(let t=0;t<d.trapRarity[e];t++)B.push(e)}),m.giftDrop&&(D=m.giftDrop),Object.keys(d.prizeRarity).forEach(e=>{if(e!==D)for(let t=0;t<d.prizeRarity[e];t++)T.push(e)}),b=Math.max(0,Math.min(214,m.numPrizes)),$=Math.max(0,Math.min(214,m.numTraps)),M=m.numBosses||1,g=m.bossEffect||"steal",O=void 0===m.volume||null===m.volume?.5:parseInt(m.volume)/100};let Oe=new Peer(null,{debug:2});function Ue(e,t=!1){ve.isServer=t,Oe.on("open",(function(t){if(null===Oe.id?Oe.id=ve.id:ve.id=Oe.id,console.log("ID:",ve.id),ve.onStart&&ve.onStart(ve.id),!ve.isServer){console.log("connecting...");let t=Oe.connect(e,{metadata:{username:"test name"}});t.on("data",(function(e){ve.onData&&ve.onData(t.peer,e)})),t.on("open",(function(){console.log(t.peer,"ready"),ve.peers[t.peer]=t,ve.onJoin&&ve.onJoin(t.peer)})),t.on("close",(function(){console.log(t.peer,"closed"),delete ve.peers[t.peer],ve.onLeave&&ve.onLeave(t.peer)})),t.on("error",(function(e){console.log(t.peer,e)}))}})),Oe.on("connection",(function(e){ve.peers[e.peer]&&console.log(e.peer,"was already connected..."),console.log(e.peer,e.label,e.metadata),e.on("data",(function(t){console.log(e.peer,"received",t),ve.onData&&ve.onData(e.peer,t)})),e.on("open",(function(){console.log(e.peer,"ready"),ve.peers[e.peer]=e,ve.onJoin&&ve.onJoin(e.peer)})),e.on("close",(function(){console.log(e.peer,"closed"),delete ve.peers[e.peer],ve.onLeave&&ve.onLeave(e.peer)})),e.on("error",(function(t){console.log(e.peer,t)}))})),Oe.on("close",(function(){ve.onDisconnect&&ve.onDisconnect()})),Oe.on("disconnected",(function(){})),Oe.on("error",(function(e){e.type,console.log(e)}))}let ve={id:null,isServer:!1,peers:{},start:()=>{Ue(null,!0)},join:e=>{Ue(e,!1)},send:function(e){Object.keys(ve.peers).forEach(t=>{ve.peers[t].open&&ve.peers[t].send(e)})},onJoin:null,onData:null,onLeave:null,onDisconnect:null};window.ComfyNetwork=ve;